<!DOCTYPE html>
<html>
<head>
<title>Thirupugazh – POS</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body { font-family: Arial; margin: 0; background: #f5f5f5; }
header { background: #1976d2; color: white; padding: 10px; display: flex; justify-content: space-between; }
.container { display: flex; height: calc(100vh - 50px); }
.menu { width: 45%; padding: 10px; background: white; }
.menu button { width: 100%; padding: 15px; margin-bottom: 10px; font-size: 18px; }
.cart { width: 55%; padding: 10px; background: #fafafa; border-left: 1px solid #ccc; }
.cart-item { display: flex; justify-content: space-between; margin-bottom: 8px; }
.total { font-size: 22px; font-weight: bold; margin-top: 10px; }
input { width: 100%; padding: 8px; margin-top: 6px; }
button { padding: 12px; width: 100%; margin-top: 10px; }
</style>
</head>

<body>

<header>
  <span>Thirupugazh – POS</span>
  <button onclick="location.reload()">Reload</button>
</header>

<div class="container">

<div class="menu">
  <h3>Menu</h3>
  <div id="menuButtons">Loading…</div>
</div>

<div class="cart">
  <h3>Customer Details</h3>
  <input id="custName" placeholder="Customer Name">
  <input id="custPhone" placeholder="Mobile Number">
  <input id="txnId" placeholder="Transaction ID">

  <h3>Cart</h3>
  <div id="cartItems"></div>
  <div class="total">Total: ₹<span id="total">0</span></div>
</div>

</div>

<script>
const API = window.location.origin;
let cartId = null;

async function init() {
    try {
        const r = await fetch(API + "/cart/create", { method: "POST" });

        if (!r.ok) {
            const t = await r.text();
            alert("Cart create failed:\n" + t);
            return;
        }

        const data = await r.json();
        cartId = data.cart_id;

        await loadMenu();
        await loadCart();

    } catch (e) {
        alert("Startup error: " + e.message);
    }
}

async function loadMenu(){
    const r = await fetch(API + "/menu");
    const menu = await r.json();
    const d = document.getElementById("menuButtons");
    d.innerHTML = "";

    menu.forEach(i=>{
        const b = document.createElement("button");
        b.innerText = `${i.name} - ₹${i.price}`;
        b.onclick = ()=>addItem(i.id);
        d.appendChild(b);
    });
}

async function addItem(id){
    await fetch(API + "/cart/add", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify({ cart_id: cartId, menu_id: id })
    });
    loadCart();
}

async function removeItem(id){
    await fetch(API + "/cart/remove", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify({ cart_id: cartId, menu_id: id })
    });
    loadCart();
}

async function loadCart(){
    const r = await fetch(API + `/cart/${cartId}`);
    const d = await r.json();
    const c = document.getElementById("cartItems");
    c.innerHTML = "";

    d.items.forEach(i=>{
        c.innerHTML += `
        <div class="cart-item">
          <span>${i.name}</span>
          <span>
            <button onclick="removeItem(${i.menu_id})">-</button>
            ${i.quantity}
            <button onclick="addItem(${i.menu_id})">+</button>
          </span>
          <span>₹${i.subtotal}</span>
        </div>`;
    });

    document.getElementById("total").innerText = d.total;
}

init();
</script>

</body>
</html>
