<script>
alert("BILLING JS LOADED");

let cartId = null;

// Create new cart
async function createCart() {
    const res = await fetch("/cart/create", { method: "POST" });
    const data = await res.json();
    cartId = data.cart_id;
    console.log("Cart created:", cartId);
}

// Load menu
async function loadMenu() {
    console.log("Loading menu...");

    const res = await fetch("/menu");
    const menu = await res.json();

    console.log("Menu data:", menu);

    const div = document.getElementById("menuButtons");
    div.innerHTML = "";

    menu.forEach(item => {
        const btn = document.createElement("button");
        btn.innerText = `${item.name} - ₹${item.price}`;
        btn.onclick = () => {
        alert("Clicked " + item.name);
        addToCart(item.id);
};
        div.appendChild(btn);
    });
}

// Add to cart
async function addToCart(menuId) {
    console.log("Adding to cart:", menuId);

    if (!cartId) {
        alert("Cart not ready yet");
        return;
    }

    const res = await fetch("/cart/add", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
            cart_id: cartId,
            menu_id: menuId,
            quantity: 1
        })
    });

    console.log("Add response status:", res.status);

    await loadCart();
}

// Load cart
async function loadCart() {
    if (!cartId) return;

    const res = await fetch(`/cart/${cartId}`);
    const data = await res.json();

    console.log("Cart data:", data);

    const div = document.getElementById("cartItems");
    div.innerHTML = "";

    data.items.forEach(i => {
        const row = document.createElement("div");
        row.className = "cart-item";
        row.innerHTML = `<span>${i.name} x ${i.quantity}</span><span>₹${i.subtotal}</span>`;
        div.appendChild(row);
    });

    document.getElementById("total").innerText = data.final_total ?? data.total;
}

// INIT
(async function init() {
    await createCart();
    await loadMenu();
    await loadCart();
})();
</script>
